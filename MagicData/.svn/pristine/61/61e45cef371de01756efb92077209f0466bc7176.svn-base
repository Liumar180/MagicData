<%@ page language="java" import="java.util.*" pageEncoding="UTF-8"%>
<%@ include file="/WEB-INF/jsp/common/common.jsp" %>
<%
String path = request.getContextPath();
String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
%>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <base href="<%=basePath%>">
    
    <title>系统配置</title>
    
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">
	<meta http-equiv="expires" content="0">    
	<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
	<meta http-equiv="description" content="This is my page">
	<link rel="stylesheet" type="text/css" href="styles/lawcase/css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="styles/systemManage/css/reset.css"/>
	<style type="text/css">
		.abc {
		    color: red;
		    width: 200px;
		}
		tr .tdWidth {
			width: 220px;
		}
	</style>
  </head>
  
  <body>
  	<div class="">
		<table id="tableid">
			<tr>
				<td>节点类型</td>
				<td>第一默认值</td>
				<td>第二默认值</td>
				<td>图片预览</td>
				<td>图标修改</td>
			</tr>
		</table>
	</div>
  	<div class="resetbtnDiv">
    	<input type="button" class="resetBtn"  onclick="save()" value="保存">
    </div>
    
    <script type="text/javascript" src="scripts/jquery.min.js"></script>
    <script type="text/javascript" src="styles/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="styles/bootstrap/js/bootstrap-prompts-alert.js"></script>
	<script type="text/javascript" src="scripts/ajaxfilesupload.js"></script>
    <script type="text/javascript">
    	var datas ;
    	$(function(){
    		$.ajax({
    			type:"post",
    			url:"dataManage/getTitanStructure.action",
    			success:function(data){
    				datas = data;
    				var vertexs = data[0];
    				var vertexsView = data[2];
    				var html = "";
    				for(var lable in vertexs){
						html += "<tr>";
    					html += "<td style='width:90px;'>"+lable+"</td>";
    					var propertyArr = vertexs[lable];
    					var viewArr = vertexsView[lable];
    					var first = viewArr[0];//第一个默认显示值
    					var	second = viewArr[1];//第二个默认值
    					if(propertyArr){
    						html += "<td class='tdWidth'><select class='abc' name='"+lable+"-0'>";
    						var tempHtml = "";
//     						var fileHtml = "";
	    					for(var i=0;i<propertyArr.length;i++){
	    						var property = propertyArr[i].name;
	    						if(first && first == property){
	    							html += "<option value='"+property+"' selected='selected'>"+property+"</option>";
	    						}else{
	    							html += "<option value='"+property+"'>"+property+"</option>";  
	    						}
	    						if(second && second == property){
	    							tempHtml += "<option value='"+property+"' selected='selected'>"+property+"</option>";
	    						}else{
	    							tempHtml += "<option value='"+property+"'>"+property+"</option>";  
	    						}
// 	    						fileHtml += ;
	    					}
	    					html += "</select></td>";
	    					
	    					html += "<td class='tdWidth'><select class='abc' name='"+lable+"-1'>";
	    					html += tempHtml;
	    					html += "</select></td>";
	    					html += "<td style='height:60px;width:70px;'><img src='images/img/"+lable+".png'  style='height:50px;width:50px;'/></td>";
	    					html += "<td class='tdWidth'><input type='file' id='"+lable+"' name='file'/></td>";
    					}
    					html += "</tr>";
    				}
    				$("#tableid").append(html);
    			}
    		});
    	})
    	function save(){
    		var fileIds  = [];
    		var fileIdsImg = [];
    		var flag = false;
    		$("input[type='file']").each(function(){
    			var id = $(this).attr("id");
				var value = $(this).val();
				if(value){
					var img = value.substring(value.lastIndexOf("\\")+1, value.length);
					
					/* if(id+".png" == img){
						fileIds.push(id);
					}else{
						parent.hintManager.showHint("图片名称必须为节点类型，图片格式为.png。请重新上传！");
						flag = true;
						return false;
					} */
					fileIds.push(id);
					fileIdsImg.push(id);
				}
				
	        });
    		if(flag) return;
    		confirm("是否要重新设置默认显示值？",function(){
				var vertexsView = datas[2];
	    		$("select").each(function(){
	    			var name = $(this).attr("name");
					var value = $(this).val();
					var nameArr = name.split("-");
					vertexsView[nameArr[0]][nameArr[1]] = value;
					
		        });
	    		$.ajaxFileUpload({
			         type:"post",
			         url:"titanStruManage/uploadImgs.action",
			         dataType:"json",
			         data:{"datas" : JSON.stringify(datas).replace(new RegExp("\"","g"),"'"),"fileIdsImg":fileIdsImg},
			         fileElementId : fileIds, 
			         success:function(data){
			        	 var result = data.result;
			        	 if(result){
						 	parent.hintManager.showInfoHint("保存设置成功。");
			        	 }else{
			        		parent.hintManager.showHint("保存设置失败，请联系管理员！");
			        	 }
			         },
			         error:function(){
			         	parent.hintManager.showHint("保存设置异常，请联系管理员！");
			         }
			     });
			});
    	}
    </script>
  </body>
</html>
