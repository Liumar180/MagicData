package com.integrity.dataSmart.titanGraph.action;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpSession;

import org.apache.log4j.Logger;
import org.apache.struts2.ServletActionContext;

import com.integrity.dataSmart.common.DataType;
import com.integrity.dataSmart.titanGraph.bean.GroupMembersBean;
import com.integrity.dataSmart.titanGraph.bean.QQFriend;
import com.integrity.dataSmart.titanGraph.bean.QqGroupsBeans;
import com.integrity.dataSmart.titanGraph.service.SearchQqRelationService;
import com.integrity.dataSmart.util.titan.TitanGraphUtil;
import com.opensymphony.xwork2.ActionSupport;
import com.thinkaurelius.titan.core.TitanGraph;
import com.tinkerpop.blueprints.Vertex;

/**
 * @author liubf
 * 查询qq关联信息action
 *
 */
public class SearchQqRelationAction extends ActionSupport{
	private static final long serialVersionUID = 1L;
	private SearchQqRelationService searchQqRelationService;
	
	private List<QQFriend> friendslist;
	private String qq;
	private String groupNum;
	private Map<String, Object> root;
	private TitanGraph graph = TitanGraphUtil.getInstance().getTitanGraph();
	private SimpleDateFormat simpleDateFormat = new SimpleDateFormat(DataType.DATEFORMATSTR);

	private Logger logger = Logger.getLogger(SearchQqRelationAction.class);
	
	public String searchQQFriendsByQq(){
		/*List<QQFriend> list = searchQqRelationService.queryQqFriendsFromOrcl(qq);
		String realName = searchQqRelationService.realNameWeigth(qq);
		String flag = searchQqRelationService.ReformQQFriends(list, qq,realName, graph);*/
		HttpSession hs = ServletActionContext.getRequest().getSession();
		List<List<Vertex>> list = searchQqRelationService.queryQqFriends(qq,graph);
		root = searchQqRelationService.queryQQFriendsJson(hs,list);
		System.out.println(root);
		return SUCCESS;
	}
	public String searchgGroupsByQq(){
		HttpSession hs = ServletActionContext.getRequest().getSession();
		try {
		List<QqGroupsBeans> groups = searchQqRelationService.queryQqGroups(qq);
		String realName = searchQqRelationService.realNameWeigth(qq);
		searchQqRelationService.ReformGroups(groups, qq,realName, graph);
		root = searchQqRelationService.findGroupRelativeByqqNum(hs,qq,graph);
		} catch (Exception e) {
			logger.error("查询群组信息异常："+e.getMessage());
		}
		return SUCCESS;
	}


	public String searchGroupMembers(){
		HttpSession hs = ServletActionContext.getRequest().getSession();
		try {
		List<GroupMembersBean> members  = searchQqRelationService.queryMembersByGnum(groupNum);
		List<QqGroupsBeans> list = new ArrayList<QqGroupsBeans>();
		for(GroupMembersBean gs:members){
			QqGroupsBeans qgb = new QqGroupsBeans();
			qgb.setNumid(gs.getMemberNum());
			String realName = searchQqRelationService.realNameWeigth(gs.getMemberNum());
			qgb.setRealName(realName);
			qgb.setMyMark(gs.getMemberRemark());
			qgb.setGroupNum(groupNum);
			list.add(qgb);
		}
		searchQqRelationService.ReformGroups(list, null,null, graph);
		root = searchQqRelationService.findGroupMemberBygroNum(hs, groupNum, graph);
			
		} catch (Exception e) {
			logger.error("查询群成员信息异常："+e.getMessage());
		}
		return SUCCESS;
	}
	
	
	public SearchQqRelationService getSearchQqRelationService() {
		return searchQqRelationService;
	}
	public void setSearchQqRelationService(
			SearchQqRelationService searchQqRelationService) {
		this.searchQqRelationService = searchQqRelationService;
	}
	public String getQq() {
		return qq;
	}
	public void setQq(String qq) {
		this.qq = qq;
	}
	public List<QQFriend> getFriendslist() {
		return friendslist;
	}
	public void setFriendslist(List<QQFriend> friendslist) {
		this.friendslist = friendslist;
	}
	
	public Map<String, Object> getRoot() {
		return root;
	}
	public void setRoot(Map<String, Object> root) {
		this.root = root;
	}
	public String getGroupNum() {
		return groupNum;
	}
	public void setGroupNum(String groupNum) {
		this.groupNum = groupNum;
	}
	

	
	

}
